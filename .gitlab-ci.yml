include:
  - template: Auto-DevOps.gitlab-ci.yml

variables:
  CODE_QUALITY_DISABLED: 'true'
  POSTGRES_ENABLED: 'false'
  BROWSER_PERFORMANCE_DISABLED: 'true'
  # TEST_DISABLED: "true"
  PRODUCTION_ADDITIONAL_HOSTS: 'veo-web.cpmsys.io'
  AUTO_DEVOPS_BUILD_IMAGE_EXTRA_ARGS: '--network=host --build-arg CI_COMMIT_REF_NAME=$CI_COMMIT_REF_NAME --build-arg CI_COMMIT_SHA=$CI_COMMIT_SHORT_SHA --build-arg CI_COMMIT_TIMESTAMP=$CI_COMMIT_TIMESTAMP --build-arg CI_JOB_ID=$CI_JOB_ID --build-arg CI_PROJECT_DIR=$CI_PROJECT_DIR --build-arg npm_config_cache=$npm_config_cache --build-arg CYPRESS_CACHE_FOLDER=$CYPRESS_CACHE_FOLDER'
  K8S_SECRET_VEO_API_USE_PROXY: 'false'
  npm_config_cache: '$CI_PROJECT_DIR/.npm' # for cypress tests
  CYPRESS_CACHE_FOLDER: '$CI_PROJECT_DIR/cache/Cypress' # for cypress tests
  CYPRESS_BASE_URL: ''

review:
  environment:
    auto_stop_in: 4 week

# for cypress tests

# # cache using branch name
# # https://gitlab.com/help/ci/caching/index.md
# cache:
#   key: $CI_COMMIT_REF_SLUG
#   paths:
#     - .npm
#     - cache/Cypress  

# build:e2e:
#   stage: build
#   image: 'registry.gitlab.com/gitlab-org/cluster-integration/auto-build-image:v1.0.0'
#   variables:
#     DOCKERFILE_PATH: "nbrx_e2e.Dockerfile"
#     CI_REGISTRY_IMAGE: "$CI_REGISTRY/$CI_PROJECT_PATH/cypress"
#   services:
#     - name: 'docker:20.10.6-dind'
#       command: ['--tls=false', '--host=tcp://0.0.0.0:2375']
#   script:
#     - |
#       if [[ -z "$CI_COMMIT_TAG" ]]; then
#         export CI_APPLICATION_REPOSITORY=${CI_APPLICATION_REPOSITORY:-$CI_REGISTRY_IMAGE/$CI_COMMIT_REF_SLUG}
#         export CI_APPLICATION_TAG=${CI_APPLICATION_TAG:-$CI_COMMIT_SHA}
#       else
#         export CI_APPLICATION_REPOSITORY=${CI_APPLICATION_REPOSITORY:-$CI_REGISTRY_IMAGE}
#         export CI_APPLICATION_TAG=${CI_APPLICATION_TAG:-$CI_COMMIT_TAG}
#       fi
#     - /build/build.sh
#   rules:
#     - if: '$BUILD_DISABLED'
#       when: never
#     - if: '$AUTO_DEVOPS_PLATFORM_TARGET == "EC2"'
#       when: never
#     - if: '$CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH  == "develop"'
#       when: always
#     - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
#       when: manual

build:e2e:
  stage: build
  image: cypress/base:14.15.4
  cache:
    key: e2e
    paths:
      - $CI_PROJECT_DIR
    policy: push
  script:
    - pwd && ls -al
    # Install npm v7 to work with lockfile:2
    - npm install -g npm@7.20.1
    - npm install
    - npm run build
    - ls -al
    - ls -al /root/
  rules:
    - if: '$BUILD_DISABLED'
      when: never
    - if: '$AUTO_DEVOPS_PLATFORM_TARGET == "EC2"'
      when: never
    - if: '$CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH  == "develop"'
      when: always
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: always

test:e2e:
  stage: test
  cache:
    key: e2e
    paths:
      - $CI_PROJECT_DIR
    policy: pull  
  variables:
    VEO_API_USE_PROXY: 'true'
    GIT_STRATEGY: none
  script:
    - pwd
    - ls -al
    - ls -al /root/
    - ls -al /
    # - cd /usr/src/app
    # - (npm run start&)
    # - ls -al
    # - ls -al ./cypress
    # - cp -r $CI_PROJECT_DIR/.npm $CI_PROJECT_DIR/cache /usr/src/app #test
    - LANG='de_DE.UTF-8' npm run test:e2e -- --config baseUrl=http://localhost:5000
    - npx nyc report --reporter=cobertura --reporter=text-summary
  after_script:
  # Copy cypress files to Gitlab project dir to make artifacts work (Artifacts are only include if they are relative to $CI_PROJECT_DIR) 
  # https://gitlab.com/gitlab-org/gitlab-foss/-/issues/15530 or https://forum.gitlab.com/t/gitlab-ci-artifacts-not-found/7588
    # - cp -r /usr/src/app/cypress $CI_PROJECT_DIR
  rules:
    - if: '$TEST_DISABLED'
      when: never
    - if: '$CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH  == "develop"'
      when: always
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: always
  needs:
    - job: build:e2e
  artifacts:
    reports:
      cobertura: cypress/coverage/cobertura-coverage.xml
    when: always
    paths:
      - cypress/videos/**/*.mp4
      - cypress/screenshots/**/*.png
      - cypress/coverage/**/*
    expire_in: 1 day