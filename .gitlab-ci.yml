include:
  - template: Auto-DevOps.gitlab-ci.yml

variables:
  CODE_QUALITY_DISABLED: 'true'
  POSTGRES_ENABLED: 'false'
  BROWSER_PERFORMANCE_DISABLED: 'true'
  # TEST_DISABLED: "true"
  PRODUCTION_ADDITIONAL_HOSTS: 'veo-web.cpmsys.io'
  AUTO_DEVOPS_BUILD_IMAGE_EXTRA_ARGS: '--network=host --build-arg CI_COMMIT_REF_NAME=$CI_COMMIT_REF_NAME --build-arg CI_COMMIT_SHA=$CI_COMMIT_SHORT_SHA --build-arg CI_COMMIT_TIMESTAMP=$CI_COMMIT_TIMESTAMP --build-arg CI_JOB_ID=$CI_JOB_ID'
  K8S_SECRET_VEO_API_USE_PROXY: 'false'
  npm_config_cache: '$CI_PROJECT_DIR/.npm' # for cypress tests
  CYPRESS_CACHE_FOLDER: '$CI_PROJECT_DIR/cache/Cypress' # for cypress tests
  CYPRESS_BASE_URL: ''

review:
  environment:
    auto_stop_in: 4 week

# for cypress tests

# cache using branch name
# https://gitlab.com/help/ci/caching/index.md
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .npm
    - cache/Cypress

test:e2e:
  image: cypress/base:14.15.4
  stage: performance
  tags:
    - 'cpmsys01'
  variables:
    VEO_API_USE_PROXY: 'false'
    VEO_API_URL: https://veo.develop.cpmsys.io/
  script:
    - npm ci
    - CYPRESS_BASE_URL=$(cat environment_url.txt)
    - npm run test:e2e -- --config baseUrl="$CYPRESS_BASE_URL"
  rules:
    - if: '$TEST_DISABLED'
      when: never
    - if: '$CI_COMMIT_TAG || $CI_COMMIT_BRANCH'
  artifacts:
    when: always
    paths:
      - cypress/videos/**/*.mp4
      - cypress/screenshots/**/*.png
      - cypress/coverage/**/*
    expire_in: 1 day
