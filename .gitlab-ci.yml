include:
  - template: Auto-DevOps.gitlab-ci.yml

variables:
  CODE_QUALITY_DISABLED: 'true'
  POSTGRES_ENABLED: 'false'
  PERFORMANCE_DISABLED: 'true'
  # TEST_DISABLED: "true"
  PRODUCTION_ADDITIONAL_HOSTS: 'veo-web.cpmsys.io'
  AUTO_DEVOPS_BUILD_IMAGE_EXTRA_ARGS: '--network=host --build-arg CI_COMMIT_REF_NAME=$CI_COMMIT_REF_NAME --build-arg CI_COMMIT_SHA=$CI_COMMIT_SHA'
  K8S_SECRET_VEO_API_USE_PROXY: 'false'
  npm_config_cache: '$CI_PROJECT_DIR/.npm' # for cypress tests
  CYPRESS_CACHE_FOLDER: '$CI_PROJECT_DIR/cache/Cypress' # for cypress tests

review:
  environment:
    auto_stop_in: 4 week

# for cypress tests

# cache using branch name
# https://gitlab.com/help/ci/caching/index.md
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .npm
    - cache/Cypress

test:e2e:
  image: cypress/base:14.15.4
  stage: performance
  tags:
    - 'cpmsys01'
  variables:
    VEO_API_USE_PROXY: 'false'
    VEO_API_URL: https://veo.develop.cpmsys.io/
  script:
    - npm ci
    - echo $CI_COMMIT_REF_SLUG
    - npm run test:e2e -- --config baseUrl="https://131-review-164-veo-49-6ankbc.on.nbrx.de"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: never
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: always
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      when: always
  artifacts:
    when: always
    paths:
      - cypress/videos/**/*.mp4
      - cypress/screenshots/**/*.png
    expire_in: 1 day
# test_e2e:
#   image: cypress/base:14.15.4
#   stage: test_e2e
#   tags:
#     - 'cpmsys01'
#   variables:
#     VEO_API_USE_PROXY: "false"
#     VEO_API_URL: https://veo.develop.cpmsys.io/
#   before_script:
#     - npm ci
#     - npm run cy:verify
#     - npm run build
#   script:
#     # - npm install
#     # - npm run build
#     # print CI environment variables for reference
#     # - $(npm bin)/print-env CI
#     # make sure Cypress can run
#     # - npm run cy:verify
#     # start the server in the background
#     # - npm run start &
#     - npm run test:e2e-ci
#   rules:
#     - if: $CI_PIPELINE_SOURCE == "merge_request_event"
#       when: never
#     - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
#       when: always
#     - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
#       when: always
#   artifacts:
#     when: always
#     paths:
#       - cypress/videos/**/*.mp4
#       - cypress/screenshots/**/*.png
#     expire_in: 1 day
