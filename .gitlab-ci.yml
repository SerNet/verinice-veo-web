include:
  - template: Auto-DevOps.gitlab-ci.yml

variables:
  KUBE_INGRESS_BASE_DOMAIN: cpmsys.io
  DEVOPS_APP_NAME: veo-web

  POSTGRES_USER: verinice
  POSTGRES_PASSWORD: verinice
  POSTGRES_ENABLED: "false"
  POSTGRES_DB: v2020

  TEST_DISABLED: 'true'
  CODE_QUALITY_DISABLED: 'true'
  PERFORMANCE_DISABLED: 'true'

  CI_PROJECT_PATH_SLUG: 'veo-web'

build:
  stage: build
  image: "registry.git.cpmsys.de/docker/auto-build-image/master:stable"
  services:
    - docker:stable-dind
  script:
    - /build/build.sh
  only:
    - branches
    - tags

push-sernet:
  stage: production
  image: registry.git.cpmsys.de/markus/sernet-env/master:latest
  script:
    - echo 172.17.0.1 git.verinice.org >> /etc/hosts
    - apk add --update git openssh
    - mkdir -p ~/.ssh && cp /usr/src/app/ssh/* ~/.ssh/
    - chmod -R 0400 ~/.ssh/*
    - git config --global user.email "$GITLAB_USER_EMAIL"
    - git config --global user.name "$GITLAB_USER_NAME"
    - git clone ssh://git.verinice.org/isms/verinice-veo-web.git /usr/src/verinice-export
    - cp -Rf ./* /usr/src/verinice-export
    - cd /usr/src/verinice-export
    - git add -A
    - git commit -am "${CI_COMMIT_TITLE}"
    - git push origin -f master
  except:
    - tags
  when: manual
  tags:
    - nas

release-sernet:
  stage: production
  image: registry.git.cpmsys.de/markus/sernet-env/master:latest
  script:
    - echo 172.17.0.1 git.verinice.org >> /etc/hosts
    - apk add --update git openssh
    - mkdir -p ~/.ssh && cp /usr/src/app/ssh/* ~/.ssh/
    - chmod -R 0400 ~/.ssh/*
    - git config --global user.email "$GITLAB_USER_EMAIL"
    - git config --global user.name "$GITLAB_USER_NAME"
    - git clone ssh://git.verinice.org/isms/verinice-veo-web.git /usr/src/verinice-export
    - cp -Rf ./* /usr/src/verinice-export
    - cd /usr/src/verinice-export
    - echo "${CI_COMMIT_REF_NAME}" > RELEASE.md
    - git add -A
    - git commit -am "Release ${CI_COMMIT_REF_NAME}"
    - git tag -d "${CI_COMMIT_REF_NAME}" || true
    - git tag -a "${CI_COMMIT_REF_NAME}" -m "Release ${CI_COMMIT_REF_NAME}"
    - git push origin -f master --tags
  only:
    - tags
  tags:
    - nas
