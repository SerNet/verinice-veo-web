include:
  - template: Auto-DevOps.gitlab-ci.yml

variables:
  CODE_QUALITY_DISABLED: 'true'
  POSTGRES_ENABLED: 'false'
  BROWSER_PERFORMANCE_DISABLED: 'true'
  # TEST_DISABLED: "true"
  PRODUCTION_ADDITIONAL_HOSTS: 'veo-web.cpmsys.io'
  AUTO_DEVOPS_BUILD_IMAGE_EXTRA_ARGS: '--network=host --build-arg CI_COMMIT_REF_NAME=$CI_COMMIT_REF_NAME --build-arg CI_COMMIT_SHA=$CI_COMMIT_SHORT_SHA --build-arg CI_COMMIT_TIMESTAMP=$CI_COMMIT_TIMESTAMP --build-arg CI_JOB_ID=$CI_JOB_ID --build-arg BUILDKIT_INLINE_CACHE=1'
  npm_config_cache: '$CI_PROJECT_DIR/.npm' # for cypress tests
  CYPRESS_CACHE_FOLDER: '$CI_PROJECT_DIR/cache/Cypress' # for cypress tests
  CYPRESS_BASE_URL: ''

review:
  environment:
    auto_stop_in: 4 week

test:e2e:
  stage: performance
  tags:
    - 'cpmsys01'
  image: cypress/base:14.15.4
  variables:
    GIT_STRATEGY: none
    NODE_ENV: production
  script:
    - CYPRESS_BASE_URL=$(cat environment_url.txt)
    - LANG='de_DE.UTF-8' npm run test:e2e -- --config baseUrl="$CYPRESS_BASE_URL"
  after_script:
    # Create cobertura report
    - npx nyc report --reporter=cobertura --reporter=text-summary
  rules:
    - if: '$TEST_DISABLED'
      when: never
    - if: '$CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH  == "develop"'
      when: always
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: always
  artifacts:
    reports:
      cobertura: cypress/coverage/cobertura-coverage.xml
    when: always
    paths:
      - cypress/videos/**/*.mp4
      - cypress/screenshots/**/*.png
      - cypress/coverage/**/*
    expire_in: 1 day